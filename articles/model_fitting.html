<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="StreamVAST">
<title>Fitting a VAST Model • StreamVAST</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fitting a VAST Model">
<meta property="og:description" content="StreamVAST">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">StreamVAST</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/model_fitting.html">Fitting a VAST Model</a>
    <a class="dropdown-item" href="../articles/shape_prep.html">Preparing a Stream Network</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Fitting a VAST Model</h1>
            
      
      
      <div class="d-none name"><code>model_fitting.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jpharris7.github.io/StreamVAST/" class="external-link">StreamVAST</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/James-Thorson-NOAA/VAST" class="external-link">VAST</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: TMB</span></span>
<span><span class="co">#&gt; Loading required package: FishStatsUtils</span></span>
<span><span class="co">#&gt; Loading required package: units</span></span>
<span><span class="co">#&gt; udunits database from C:/Users/harj3477/AppData/Local/R/win-library/4.2/units/share/udunits/udunits2.xml</span></span>
<span><span class="co">#&gt; Loading required package: marginaleffects</span></span>
<span><span class="co">#&gt; ###########################################################################################</span></span>
<span><span class="co">#&gt; Loading package VAST version 3.10.0</span></span>
<span><span class="co">#&gt; For information and examples, please see http://github.com/james-thorson/VAST/</span></span>
<span><span class="co">#&gt; ###########################################################################################</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.9.3, GDAL 3.5.2, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://luukvdmeer.github.io/sfnetworks/" class="external-link">sfnetworks</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">splines</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="important-note">Important note<a class="anchor" aria-label="anchor" href="#important-note"></a>
</h2>
<p>A new version of VAST, tinyVAST, is currently being developed and is
likely to offer improved stability in the long term. Anticipate that
much of this chapter will change as the code migrates to use tinyVAST
instead of VAST.</p>
</div>
<div class="section level2">
<h2 id="fitting-a-vast-model-to-stream-network-data">Fitting a VAST Model to Stream Network Data<a class="anchor" aria-label="anchor" href="#fitting-a-vast-model-to-stream-network-data"></a>
</h2>
<p>This is the second chapter explaining how to use the functions in the
StreamVAST package. For information on how to prepare and format data,
please refer to the previous chapter <a href="articles/shape_prep.html">Preparing a Stream Network</a></p>
<p>In the previous chapter, we imported data for steelhead salmon redds
in the Mill Creek watershed, in Washington State. The two most important
data objects are a data frame with the dates and locations of redds, and
an sf object with LINESTRINGS defining the different segments of the
network. A third object, the set of survey tracks is also useful. Future
versions of this package will make use of S3 classes to streamline the
tracking of these objects.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   X Year Day Reach   Effort Redds habitat  STRM_NAME  root parent</span></span>
<span><span class="co">#&gt; 1 1 2013  64     1 2465.601     0    TRUE Mill Creek  TRUE     NA</span></span>
<span><span class="co">#&gt; 2 2 2013  64     2 3499.699     0    TRUE Mill Creek FALSE      1</span></span>
<span><span class="co">#&gt; 3 3 2013  64     3 3354.350     0    TRUE Mill Creek FALSE      2</span></span>
<span><span class="co">#&gt; 4 4 2013  64     4 3354.350     0    TRUE Mill Creek FALSE      3</span></span>
<span><span class="co">#&gt; 5 5 2013  78     1 2465.601     0    TRUE Mill Creek  TRUE     NA</span></span>
<span><span class="co">#&gt; 6 6 2013  78     2 3499.699     0    TRUE Mill Creek FALSE      1</span></span>
<span><span class="co">#&gt;   parent.distance</span></span>
<span><span class="co">#&gt; 1              NA</span></span>
<span><span class="co">#&gt; 2        3499.699</span></span>
<span><span class="co">#&gt; 3        3427.024</span></span>
<span><span class="co">#&gt; 4        3354.350</span></span>
<span><span class="co">#&gt; 5              NA</span></span>
<span><span class="co">#&gt; 6        3499.699</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Mill.reaches</span>,n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 22 features and 8 fields</span></span>
<span><span class="co">#&gt; Geometry type: LINESTRING</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 941970.7 ymin: 322499 xmax: 963147.4 ymax: 357159.5</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Washington South (ftUS)</span></span>
<span><span class="co">#&gt; First 4 features:</span></span>
<span><span class="co">#&gt;   from to habitat Reach    STRM_NA root parent  prnt_ds</span></span>
<span><span class="co">#&gt; 1    1  2       1     1 Mill Creek    1     NA       NA</span></span>
<span><span class="co">#&gt; 2    2  3       1     2 Mill Creek    0      1 3499.699</span></span>
<span><span class="co">#&gt; 3    3  4       1     3 Mill Creek    0      2 3427.024</span></span>
<span><span class="co">#&gt; 4    4  5       1     4 Mill Creek    0      3 3354.350</span></span>
<span><span class="co">#&gt;                         geometry</span></span>
<span><span class="co">#&gt; 1 LINESTRING (963147.4 322499...</span></span>
<span><span class="co">#&gt; 2 LINESTRING (961311.9 324437...</span></span>
<span><span class="co">#&gt; 3 LINESTRING (958655.6 326211...</span></span>
<span><span class="co">#&gt; 4 LINESTRING (958123.2 328790...</span></span></code></pre></div>
<div class="section level3">
<h3 id="additional-formatting-for-vast">Additional formatting for VAST<a class="anchor" aria-label="anchor" href="#additional-formatting-for-vast"></a>
</h3>
<p>There are a few more minor formatting tasks that need to be completed
before we can fit a model. We need to draw information from Mill.reaches
to add an “Area” column that tracks the total area in each reach,
separate from the “Effort”. The date will also be converted into a
variety of formats (statistical week, Month) that will be useful later.
The objects are returned with additional formating as a streamvast class
object. This object has numerous elements that will be gradually filled
in using additional functions. This function also produces a map of the
spatial frame and the data coverage provided by the surveys that can be
useful as a diagnostic check.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/ConstructStreamVAST.html">ConstructStreamVAST</a></span><span class="op">(</span>countdata <span class="op">=</span> <span class="va">Mill.data</span>,reachdata <span class="op">=</span> <span class="va">Mill.reaches</span>,surveydata <span class="op">=</span> <span class="va">Mill.surveys</span>,reachname <span class="op">=</span> <span class="st">"Reach"</span>,countname <span class="op">=</span> <span class="st">"Redds"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Initializing StreamVAST based on countdata and reachdata"</span></span>
<span><span class="co">#&gt; [1] "Converting length units to kilometers (Default)"</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Vast requires specific formatting to define the spatial relationships
along a stream network, and the above function calculates them
automatically. Of particular note, is the “reachname” argument. The
reachname is used as a key to unify different components, and must be
consistent across all the datasets that feed into the process. The
streamvast class also has a variety of slots reserved for the model and
model outputs that are likely to be useful at later steps. In future
steps, these slots will be gradually filled in, providing a convenient
structure for storing the large number of outputs generated by VAST.</p>
</div>
<div class="section level3">
<h3 id="choosing-a-temporal-resolution">Choosing a temporal resolution<a class="anchor" aria-label="anchor" href="#choosing-a-temporal-resolution"></a>
</h3>
<p>Depending on the system being modeled, a variety of temporal
resolutions are possible. The second step is to define the temporal
resolution, which will determine the overall structure of the vast model
and predictions. Use the function “SetTemporalFrame” For this example,
we will set the temporal resolution to two weeks, and will cover the 5
months from Feb. to June. We will also pad the ends of the data set with
zeros, to mark the ends of the season.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/SetTemporalFrame.html">SetTemporalFrame</a></span><span class="op">(</span>streamvast <span class="op">=</span> <span class="va">Mill.vast</span>,Time <span class="op">=</span> <span class="st">"Month"</span>,</span>
<span>                                  startdate <span class="op">=</span> <span class="st">"2013-02-01"</span>,enddate <span class="op">=</span> <span class="st">"2022-06-30"</span>,padzero <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>This function fills in several slots of the Mill.vast object. The
first is a data frame that contains everything we will need for VAST.
This data frame has three important additions. First, the temporal
element has been converted into a generic “Time” period that runs in
sequence. It also includes two columns “Original” and “Dummy”. The
Original column identifies actual data points, while the Dummy column
identifies time periods or reaches for which no data is available, but
that we would like the model to output a prediction.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">vastdata</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Time Year Day Month Reach vastid Redds Density     Area    Effort      Lat</span></span>
<span><span class="co">#&gt; 1    2 2013  64   Mar     1      1     0       0 1.066710 0.7515168 46.19086</span></span>
<span><span class="co">#&gt; 2    2 2013  64   Mar     2      2     0       0 1.066710 1.0667105 46.19420</span></span>
<span><span class="co">#&gt; 3    2 2013  64   Mar     3      3     0       0 1.022408 1.0224078 46.19933</span></span>
<span><span class="co">#&gt; 4    2 2013  64   Mar     4      4     0       0 1.022408 1.0224078 46.20602</span></span>
<span><span class="co">#&gt; 5    2 2013  78   Mar     1      1     0       0 1.066710 0.7515168 46.19086</span></span>
<span><span class="co">#&gt; 6    2 2013  78   Mar     2      2     0       0 1.066710 1.0667105 46.19420</span></span>
<span><span class="co">#&gt;         Lon original dummy</span></span>
<span><span class="co">#&gt; 1 -123.1760     TRUE FALSE</span></span>
<span><span class="co">#&gt; 2 -123.1866     TRUE FALSE</span></span>
<span><span class="co">#&gt; 3 -123.1954     TRUE FALSE</span></span>
<span><span class="co">#&gt; 4 -123.1992     TRUE FALSE</span></span>
<span><span class="co">#&gt; 5 -123.1760     TRUE FALSE</span></span>
<span><span class="co">#&gt; 6 -123.1866     TRUE FALSE</span></span></code></pre></div>
<p>The second element of the list is a table that is useful for relating
the time period back to it’s normal calendar date.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">timetable</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Time Month Year    Key    Refdate Day Original</span></span>
<span><span class="co">#&gt; 1    1     2 2013 2013-2 2013-02-15  46    FALSE</span></span>
<span><span class="co">#&gt; 2    2     3 2013 2013-3 2013-03-15  74     TRUE</span></span>
<span><span class="co">#&gt; 3    3     4 2013 2013-4 2013-04-15 105     TRUE</span></span>
<span><span class="co">#&gt; 4    4     5 2013 2013-5 2013-05-15 135     TRUE</span></span>
<span><span class="co">#&gt; 5    5     6 2013 2013-6 2013-06-15 166    FALSE</span></span>
<span><span class="co">#&gt; 6    6     2 2014 2014-2 2014-02-15  46     TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="covariates">Covariates<a class="anchor" aria-label="anchor" href="#covariates"></a>
</h3>
<p>If your analysis plans to make use of covariates, now is the best
time to set those up. As before, will add them to the existing
streamvast object using the SetVASTCovariates function. VAST is capable
of supporting a wide variety of model structures and this part is
somewhat complex. Here we will show an example of how to add the
statistical (julian) day as covariate as a spline to simulate seasonal
associations in redd abundance.</p>
<p>The simplest way to add covariates is to supply a dataframe that
matches to the vastdata slot under the “covariatedata” argument.
Alternately, the “spcovars” argument can be used to supply covariates
that match to specific reaches but are constant across time, such as
elevation or slope. The “tempcovars” argument is similar for covariates
that are constant across space for a given time, such as large scale
weather patterns.</p>
<p>VAST is structured as a hurdle model and can have different covariate
structures for the probability and density components. For this example
we will include the for the probability component (“pform”), while
leaving the density component off. The formula can include a variety of
elements such as polynomials or splines. VAST is also capable of
calculating spatially varying covariate effects, which is specified
using the “pconfig” argument. This argument must be a matrix with
columns equal to the total number of coefficients being estimated, in
this case 5. See ?VAST::make_data for more details. Lastly, for
computational reasons, it is also recommended that covariate values be
centered to zero and scaled to have a standard deviation of 1.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/SetVastCovariates.html">SetVastCovariates</a></span><span class="op">(</span>streamvast <span class="op">=</span> <span class="va">Mill.vast</span>,covariatedata <span class="op">=</span> <span class="va">Mill.vast</span><span class="op">$</span><span class="va">vastdata</span>,pform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/splines/bs.html" class="external-link">bs</a></span><span class="op">(</span><span class="va">Day</span>,degree<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>,pconfig<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="fl">1</span>,ncol<span class="op">=</span><span class="fl">5</span>,data<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,center <span class="op">=</span> <span class="cn">T</span>,scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="an-example-in-vast">An example in VAST<a class="anchor" aria-label="anchor" href="#an-example-in-vast"></a>
</h3>
<p>At this point, we are almost ready to run a model. VAST contains a
wide variety of settings to allow users to effectively model different
systems, and we will first define a settings object. While streamvast
can supply default settings or run a basic optimization routine to test
multiple options, this option is slow and users are encouraged to
familiarize themselves with VAST’s myriad options. See
?VAST::make_settings for more details. Novice users can copy the below
code chunk for reference.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FishStatsUtils/man/make_settings.html" class="external-link">make_settings</a></span><span class="op">(</span>Region<span class="op">=</span><span class="st">"stream_network"</span>,</span>
<span>                          zone<span class="op">=</span><span class="fl">10</span>,</span>
<span>                          purpose <span class="op">=</span> <span class="st">"index2"</span>,</span>
<span>                          fine_scale<span class="op">=</span><span class="cn">F</span>,</span>
<span>                          n_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">reachdata</span><span class="op">)</span>,</span>
<span>                          FieldConfig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Omega1"</span><span class="op">=</span> <span class="fl">1</span>, <span class="st">"Epsilon1"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"Omega2"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"Epsilon2"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>                          RhoConfig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Beta1"</span> <span class="op">=</span> <span class="fl">2</span>, <span class="st">"Epsilon1"</span> <span class="op">=</span> <span class="fl">2</span>, <span class="st">"Beta2"</span> <span class="op">=</span> <span class="fl">2</span>, <span class="st">"Epsilon2"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                          OverdispersionConfig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Eta1"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"Eta2"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                          ObsModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                          bias.correct <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                          use_anisotropy <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">Method</span><span class="op">&lt;-</span><span class="st">"Stream_network"</span>            </span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">grid_size_km</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">reachdata</span><span class="op">$</span><span class="va">Length</span><span class="op">)</span></span></code></pre></div>
<p>It is important to specify that Region = “stream_network”, and to set
n_x equal to the number of reaches. The zone is the UTM time zone, and
purpose = “index2” specifies that our goal is abundance or density
prediction. FieldConfig is turns various components of the model on or
off (the example removes several terms for simplicity and stability),
and RhoConfig specifies the type autocorrelation (random-walk in this
case). We are not modeling the overdispersion, so these settings are set
to zero. ObsModel controls the distributions and link functions in the
model, with the current setting indicating a Poisson count model with
zero inflation. Anisotropy and fine_scale should be turned off. Please
see the VAST documentation for details.</p>
<p>It is also necessary to manually set the method to “Stream_network”
and to calculate a mean size for the prediction frame.</p>
<p>Next, we can run the model. If the preceding steps have been
successful, “RunVAST” function will look through the streamvast object
and the settings object to find all the necessary components.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/RunVAST.html">RunVAST</a></span><span class="op">(</span>streamvast <span class="op">=</span> <span class="va">Mill.vast</span>,vastsettings <span class="op">=</span> <span class="va">settings</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'Matrix' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'sp' was built under R version 4.2.3</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preliminary-checks-and-troubleshooting">Preliminary checks and Troubleshooting<a class="anchor" aria-label="anchor" href="#preliminary-checks-and-troubleshooting"></a>
</h3>
<p>The outputs of the model can be accessed from Mill.vast$vastmodel,
several of which are useful to determine if the algorithm has run
successfully. A basic check of the parameter estimates is often
advisable.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">vastmodel</span><span class="op">$</span><span class="va">parameter_estimates</span><span class="op">$</span><span class="va">Convergence_check</span></span>
<span><span class="co">#&gt; [1] "There is no evidence that the model is not converged"</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">vastmodel</span><span class="op">$</span><span class="va">parameter_estimates</span><span class="op">$</span><span class="va">AIC</span></span>
<span><span class="co">#&gt; [1] 1222.029</span></span>
<span><span class="co">#&gt; attr(,"logarithm")</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">vastmodel</span><span class="op">$</span><span class="va">parameter_estimates</span><span class="op">$</span><span class="va">number_of_coefficients</span></span>
<span><span class="co">#&gt;  Total  Fixed Random </span></span>
<span><span class="co">#&gt;   1258     14   1244</span></span></code></pre></div>
<p>If your model is not converging, experiment with the settings. It is
often productive to begin with a simple model (by inputting 0s in
FieldConfig or RhoConfig) and then to gradually increase the complexity.
Refer to the VAST documentation for specifics.</p>
<p>The predictions from the fitted VAST model can be quickly extracted
using a helper function VASTpreds. This function will format the
predictions into a data frame, and provide the density and count
estimates for each reach at each time period. It also provides upper and
lower 90% confidence bounds, based on samples drawn from the posterior
distribution.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/VASTpreds.html">VASTpreds</a></span><span class="op">(</span>streamvast <span class="op">=</span> <span class="va">Mill.vast</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Simulating predicted density distribution"</span></span>
<span><span class="co">#&gt; [1] "Simulating predicted count distribution and residuals"</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>The plots produced above are from the DHARMa package, which provides
scaled residual estimates for hierarchical models, and is a good first
step to assessing model fit. Note that when large amounts of dummy data
are included, the DHARMa plots can be misleading.</p>
<p>A second functon can produce maps from the output.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotPredictionMap.html">plotPredictionMap</a></span><span class="op">(</span>streamvast <span class="op">=</span> <span class="va">Mill.vast</span>,mapvar <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>                  make.labels <span class="op">=</span> <span class="cn">F</span>,xaxis.breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">123.24</span>,<span class="op">-</span><span class="fl">123.20</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>These maps can also be faceted by year, month, etc.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotPredictionMap.html">plotPredictionMap</a></span><span class="op">(</span>streamvast <span class="op">=</span><span class="va">Mill.vast</span>, subset<span class="op">=</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">preds</span><span class="op">$</span><span class="va">Year</span><span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2014</span>,<span class="fl">2016</span>,<span class="fl">2018</span>,<span class="fl">2020</span><span class="op">)</span>, mapvar<span class="op">=</span><span class="st">"Density"</span>,facet <span class="op">=</span> <span class="st">"Year"</span>,make.labels <span class="op">=</span> <span class="cn">F</span>,xaxis.breaks <span class="op">=</span> <span class="fl">0</span>,yaxis.breaks <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>Additional maps can be easily generated using generic plotting
functions. For instance, the average density with respect to space is
stored under the “spacedata” slot.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">spacedata</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Reach</span>,y<span class="op">=</span><span class="va">Density</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"MAG - Average Density by Reach"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Reach</span>,y<span class="op">=</span><span class="va">pDensity</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Reach</span>,y<span class="op">=</span><span class="va">pDensity_upper</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Reach</span>,y<span class="op">=</span><span class="va">pDensity_lower</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-18-1.png" width="700">
Similarly, the pattern over time is stored in “timedata.”</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">year.breaks</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">timetable</span><span class="op">$</span><span class="va">Time</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">timetable</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span>,FUN<span class="op">=</span><span class="va">min</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">timedata</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Time</span>,y<span class="op">=</span><span class="va">Density</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"MAG - Average Density by Reach"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Time</span>,y<span class="op">=</span><span class="va">pDensity</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Time</span>,y<span class="op">=</span><span class="va">pDensity_upper</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Time</span>,y<span class="op">=</span><span class="va">pDensity_lower</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">year.breaks</span><span class="op">$</span><span class="va">x</span>,labels <span class="op">=</span> <span class="va">year.breaks</span><span class="op">$</span><span class="va">Group.1</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jeremy Harris.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
