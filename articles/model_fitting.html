<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fitting a VAST Model • StreamVAST</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fitting a VAST Model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">StreamVAST</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/model_fitting.html">Fitting a VAST Model</a></li>
    <li><a class="dropdown-item" href="../articles/shape_prep.html">Preparing a Stream Network</a></li>
    <li><a class="dropdown-item" href="../articles/survival_example.html">Estimating Salmonid Escapement after Fitting a VAST model</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Fitting a VAST Model</h1>
            
      

      <div class="d-none name"><code>model_fitting.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jpharris7.github.io/StreamVAST/">StreamVAST</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vast-lib.github.io/tinyVAST/" class="external-link">tinyVAST</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ###########################################################################################</span></span>
<span><span class="co">#&gt; Loading package tinyVAST version 0.7.0</span></span>
<span><span class="co">#&gt; This package is under development, and the interface may change at any time</span></span>
<span><span class="co">#&gt; The authors hope to establish a stable interface by end of 2024</span></span>
<span><span class="co">#&gt; ###########################################################################################</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.11.2, GDAL 3.8.2, PROJ 9.3.1; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://luukvdmeer.github.io/sfnetworks/" class="external-link">sfnetworks</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="fitting-a-tinyvast-model-to-stream-network-data">Fitting a tinyVAST Model to Stream Network Data<a class="anchor" aria-label="anchor" href="#fitting-a-tinyvast-model-to-stream-network-data"></a>
</h2>
<p>This is the second chapter explaining how to use the functions in the
StreamVAST package. For information on how to prepare and format data,
please refer to the previous chapter <a href="articles/shape_prep.html">Preparing a Stream Network</a></p>
<p>In the previous chapter, we imported data for steelhead salmon redds
in the Mill Creek watershed, in Washington State. The two most important
data objects are a data frame with the dates and locations of redds, and
an sf object with LINESTRINGS defining the different segments of the
network.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Year Day Reach    Effort Redds habitat  STRM_NAME  root parent</span></span>
<span><span class="co">#&gt; 1 2013  64     1 0.7515168     0    TRUE Mill Creek  TRUE     NA</span></span>
<span><span class="co">#&gt; 2 2013  64     2 1.0667105     0    TRUE Mill Creek FALSE      1</span></span>
<span><span class="co">#&gt; 3 2013  64     3 1.0224078     0    TRUE Mill Creek FALSE      2</span></span>
<span><span class="co">#&gt; 4 2013  64     4 1.0224078     0    TRUE Mill Creek FALSE      3</span></span>
<span><span class="co">#&gt; 5 2013  78     1 0.7515168     0    TRUE Mill Creek  TRUE     NA</span></span>
<span><span class="co">#&gt; 6 2013  78     2 1.0667105     0    TRUE Mill Creek FALSE      1</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Mill.reaches</span>,n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 22 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: LINESTRING</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 941970.7 ymin: 322499 xmax: 963147.4 ymax: 357159.5</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Washington South (ftUS)</span></span>
<span><span class="co">#&gt; First 4 features:</span></span>
<span><span class="co">#&gt;   from to habitat Reach  STRM_NAME root parent                       geometry</span></span>
<span><span class="co">#&gt; 1    1  2       1     1 Mill Creek    1     NA LINESTRING (963147.4 322499...</span></span>
<span><span class="co">#&gt; 2    2  3       1     2 Mill Creek    0      1 LINESTRING (961311.9 324437...</span></span>
<span><span class="co">#&gt; 3    3  4       1     3 Mill Creek    0      2 LINESTRING (958655.6 326211...</span></span>
<span><span class="co">#&gt; 4    4  5       1     4 Mill Creek    0      3 LINESTRING (958123.2 328790...</span></span></code></pre></div>
<div class="section level3">
<h3 id="additional-formatting-for-tinyvast">Additional formatting for tinyVAST<a class="anchor" aria-label="anchor" href="#additional-formatting-for-tinyvast"></a>
</h3>
<p>There are a few more minor formatting tasks that need to be completed
before we can fit a model. We need to draw information from Mill.reaches
to add an “Area” column that tracks the total area in each reach,
separate from the “Effort”. The date will also be converted into a
variety of formats (statistical week, Month) that will be useful later.
The objects are returned with additional formating as a streamvast class
object. This object has numerous elements that will be gradually filled
in using additional functions. This function also produces a map of the
spatial frame and the data coverage provided by the surveys that can be
useful as a diagnostic check.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/ConstructStreamVAST.html">ConstructStreamVAST</a></span><span class="op">(</span>countdata <span class="op">=</span> <span class="va">Mill.data</span>,reachdata <span class="op">=</span> <span class="va">Mill.reaches</span>,surveydata <span class="op">=</span> <span class="va">Mill.surveys</span>,reachname <span class="op">=</span> <span class="st">"Reach"</span>,countname <span class="op">=</span> <span class="st">"Redds"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Initializing StreamVAST based on countdata and reachdata"</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>This will produce a “streamvast” object, which is a list with many
components. The inital data inputs “countdata”, “reachdata”, and
“surveydata” are located here. Of particular note, is the “reachname”
argument. The reachname is used as a key to unify different components,
and must be consistent across all the datasets that feed into the
process. The streamvast class also has a variety of slots reserved for
the model and model outputs that are likely to be useful at later
steps.</p>
</div>
<div class="section level3">
<h3 id="choosing-a-temporal-resolution">Choosing a temporal resolution<a class="anchor" aria-label="anchor" href="#choosing-a-temporal-resolution"></a>
</h3>
<p>Depending on the system being modeled, a variety of temporal
resolutions are possible. The second step is to define the temporal
resolution, which will determine the overall structure of the vast model
and predictions. Use the function “SetTemporalFrame” For this example,
we will set the temporal resolution to Year, and will cover the 6 months
from Jan to June. We will also pad the ends of the data set with zeros,
to mark the ends of the season. The season argument is used to define
the time period being modeled beyond the start and end year. It is
always an integer vector of the form c(starting month, starting day,
ending month, ending day). In the example below, the season is defined
from Jan. 1, to June 30. It is possible to construct seasons that run
past Dec 31 using this argument.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/SetTemporalFrame.html">SetTemporalFrame</a></span><span class="op">(</span>streamvast <span class="op">=</span> <span class="va">Mill.vast</span>,Time <span class="op">=</span> <span class="st">"Year"</span>,season <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">6</span>,<span class="fl">30</span><span class="op">)</span>,</span>
<span>                                  startdate <span class="op">=</span> <span class="st">"2013-01-01"</span>,enddate <span class="op">=</span> <span class="st">"2022-06-30"</span>,padyear <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>This function fills in several slots of the Mill.vast object.
Reference data for the temporal structure is located in the “timetable”
slot. Based on the settings, the table will include a “Runyear” which
may be different from the calendar year, start and end dates for each
run, a generic “Time” column that matches the order of each period and
is useful if you intend to use timescale smaller than one year. The
“Day” column that refers to the julian calendar day of the year, and a
“Statday” column that indicates how many days since the start of the
season.</p>
<p>Some other important features are “vastnetwork”, which contains the
network settings used internally by tinyVAST, and typically should not
be altered.</p>
<p>Last the “vastdata” slot contains the data frame that will be passed
to tinyVAST when fitting the model. The observations from countdata have
been matched to the “timetable” slot and now include Runyear and Statday
as well. Lon/Lat coordinates have also been added. For now, StreamVAST
is not compatible with multi-species models, though that functionality
is expected in the future. The Species and Distribution columns are
fixed for the moment. Note, that because we set the padyear option to
TRUE, zero observations are added at the start and end of the season,
which is useful for many salmonid studies.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">vastdata</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Time Runyear       Date Year Month Day Statday Reach Species Dist Redds</span></span>
<span><span class="co">#&gt; 1    1    2013 2013-03-05 2013     3   5      64     1   Redds  obs     0</span></span>
<span><span class="co">#&gt; 2    1    2013 2013-03-05 2013     3   5      64     2   Redds  obs     0</span></span>
<span><span class="co">#&gt; 3    1    2013 2013-03-05 2013     3   5      64     3   Redds  obs     0</span></span>
<span><span class="co">#&gt; 4    1    2013 2013-03-05 2013     3   5      64     4   Redds  obs     0</span></span>
<span><span class="co">#&gt; 5    1    2013 2013-03-19 2013     3  19      78     1   Redds  obs     0</span></span>
<span><span class="co">#&gt; 6    1    2013 2013-03-19 2013     3  19      78     2   Redds  obs     0</span></span>
<span><span class="co">#&gt;   Density   Length    Effort      Lat       Lon Original</span></span>
<span><span class="co">#&gt; 1       0 1.065629 0.7515168 46.19086 -123.1760     TRUE</span></span>
<span><span class="co">#&gt; 2       0 1.064799 1.0667105 46.19420 -123.1866     TRUE</span></span>
<span><span class="co">#&gt; 3       0 1.021654 1.0224078 46.19933 -123.1954     TRUE</span></span>
<span><span class="co">#&gt; 4       0 1.020937 1.0224078 46.20602 -123.1992     TRUE</span></span>
<span><span class="co">#&gt; 5       0 1.065629 0.7515168 46.19086 -123.1760     TRUE</span></span>
<span><span class="co">#&gt; 6       0 1.064799 1.0667105 46.19420 -123.1866     TRUE</span></span></code></pre></div>
<p>The second element of the list is a table that is useful for relating
the time period back to it’s normal calendar date.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">timetable</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Runyear Year      Start       Date        End Time Month Day Statday Observed</span></span>
<span><span class="co">#&gt; 1    2013 2013 2013-01-01 2013-04-01 2013-06-30    1     4  91      91     TRUE</span></span>
<span><span class="co">#&gt; 2    2014 2014 2014-01-01 2014-04-01 2014-06-30    2     4  91      91     TRUE</span></span>
<span><span class="co">#&gt; 3    2015 2015 2015-01-01 2015-04-01 2015-06-30    3     4  91      91     TRUE</span></span>
<span><span class="co">#&gt; 4    2016 2016 2016-01-01 2016-03-31 2016-06-30    4     3  91      92     TRUE</span></span>
<span><span class="co">#&gt; 5    2017 2017 2017-01-01 2017-04-01 2017-06-30    5     4  91      91     TRUE</span></span>
<span><span class="co">#&gt; 6    2018 2018 2018-01-01 2018-04-01 2018-06-30    6     4  91      91     TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="covariates">Covariates<a class="anchor" aria-label="anchor" href="#covariates"></a>
</h3>
<p>Our example does not use covariates, but they can be added to the
“vastdata” component with ease. Depending on the structure of your
covariate data, it can be matched to the date, lat/lon coordinates,
reach identifier, or any combination of these. The functions covered in
the previous chapter can be helpful. For instance, the AttachData
function can be used to map covariate values from a different shapefile
onto the network structure in “reachdata”, and then use the reach
numbers to match to vastdata.</p>
</div>
<div class="section level3">
<h3 id="an-example-in-tinyvast">An example in tinyVAST<a class="anchor" aria-label="anchor" href="#an-example-in-tinyvast"></a>
</h3>
<p>The model can be fit using the tinyVAST function. There are many
options, but the below can serve as an example. The formula section can
include a variety of fixed or random effects and uses the same syntax as
mgcv for fitting splines. In this case, we will fit a spline for
Statday, which represents our seasonal (intra-annual) patterns, and an
offset for survey effort.</p>
<p>TinyVAST uses a structural equation modeling framework for specifying
various effects, and users are advised to read more about it for
specifics. Specifying “sem = ’’”, uses the default spatial effects for a
stream network, where counts at each location are correlated by distance
with an exponential decay (Ornstein-Ulhenbeck process, see tinyVAST
documentation). The “dsem” argument is used to specify spatio-temporal
interactions, and in case we have added a 1 year lag to the default
effects.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">&lt;-</span> <span class="fu"><a href="https://vast-lib.github.io/tinyVAST/reference/tinyVAST.html" class="external-link">tinyVAST</a></span><span class="op">(</span> data <span class="op">=</span> <span class="va">Mill.vast</span><span class="op">$</span><span class="va">vastdata</span>,</span>
<span>                formula <span class="op">=</span> <span class="va">Redds</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">Statday</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">Effort</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                spatial_graph <span class="op">=</span> <span class="va">Mill.vast</span><span class="op">$</span><span class="va">vastnetwork</span>,</span>
<span>                space_columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lon"</span>,<span class="st">"Lat"</span><span class="op">)</span>,</span>
<span>                variable_column <span class="op">=</span> <span class="st">"Species"</span>,</span>
<span>                time_column <span class="op">=</span> <span class="st">"Runyear"</span>,</span>
<span>                distribution_column <span class="op">=</span> <span class="st">"Dist"</span>,</span>
<span>                sem<span class="op">=</span><span class="st">""</span>,</span>
<span>                dsem <span class="op">=</span> <span class="st">"Redds -&gt; Redds, 1, rho"</span>,</span>
<span>                family<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                control <span class="op">=</span> <span class="fu"><a href="https://vast-lib.github.io/tinyVAST/reference/tinyVASTcontrol.html" class="external-link">tinyVASTcontrol</a></span><span class="op">(</span>getJointPrecision <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preliminary-checks-and-troubleshooting">Preliminary checks and Troubleshooting<a class="anchor" aria-label="anchor" href="#preliminary-checks-and-troubleshooting"></a>
</h3>
<p>The outputs of the model can be accessed from fit, several of which
are useful to determine if the algorithm has run successfully. It is
good to check that the Hessian is positive-definite.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">sdrep</span><span class="op">$</span><span class="va">pdHess</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>It is also wise to look at the component loadings and check that they
have reasonable Std. Errors. In the table, alpha terms refer to fixed
effects, log_lambda terms refer to splines, beta terms refer to spatial
effect, and theta refers to the spatio-temporal effect. Log_kappa is the
term for the decorrelation distance in the spatial and spatio-temporal
effects.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">sdrep</span></span>
<span><span class="co">#&gt; sdreport(.) result</span></span>
<span><span class="co">#&gt;              Estimate Std. Error</span></span>
<span><span class="co">#&gt; alpha_j    -5.1040345  0.8766787</span></span>
<span><span class="co">#&gt; beta_z      0.6949493  0.1743692</span></span>
<span><span class="co">#&gt; beta_z      1.0126676  0.1854858</span></span>
<span><span class="co">#&gt; theta_z     1.3674885  0.5216452</span></span>
<span><span class="co">#&gt; log_lambda -3.2266104  0.7168398</span></span>
<span><span class="co">#&gt; log_kappa  -1.0713416  0.6030238</span></span>
<span><span class="co">#&gt; Maximum gradient component: 5.023135e-05</span></span></code></pre></div>
<p>Consider removing terms that are poorly estimated, or else adjust the
model structure until you are satisfied with the results. When ready to
proceed, add the model to the streamvast object.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">vastmodel</span><span class="op">&lt;-</span><span class="va">fit</span></span></code></pre></div>
<p>The predictions from the fitted tinyVAST model can be quickly
extracted using a helper function VASTpreds. This function will format
the predictions into several data frames, and provide the density and
count estimates for each reach at each time period. It also provides
upper and lower 95% confidence bounds, based on samples drawn from the
posterior distribution. If desired, it can also produce area under the
curve estimates useful for many salmonids (note, not AUC as in the AUROC
statistic for classification success). Users can also specify the number
of simulated draws to make for estimating confidence intervals. A bias
correction option exists for removing the transformation bias associated
with drawing normal samples from the posterior of a poisson distrubtion,
but it is computationally expensive and time consuming. Users can also
supply a newdata argument if predictions at a specific points are
desired, though the predict function can also be used on fit for a
similar effect.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/VASTpreds.html">VASTpreds</a></span><span class="op">(</span>streamvast <span class="op">=</span> <span class="va">Mill.vast</span>,makeauc <span class="op">=</span> <span class="cn">T</span>,nsims <span class="op">=</span> <span class="fl">100</span>,bias.correct <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p>This function will have filled in many of the remaining components in
the streamvast object. The “stats” component has some summary stats. By
default, the “preds” component will contain estimates scaled to full
survey effort, and reflects the best estimate of density for each reach
at each time. The “eval” componenet contains fitted values matched to
observed survey effort, and is useful for evaluating residuals.
Spacedata and timedata provide average estimates by time or space.
Aucdata is a list that contains area under the curve estimates for each
reach and year, as well as totals by year. The “sims” component contains
simulated counts of several types based on the posterior draws.</p>
<p>It’s always a good idea to plot your residuals. Tinyvast models are
also compatible with the DHARMa package to make useful plots for
assessing problems. A helper function makes it easier</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">resplot</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">eval</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">fit_Density</span>,y<span class="op">=</span><span class="va">Density</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>,intercept <span class="op">=</span> <span class="fl">0</span>,col<span class="op">=</span><span class="fl">2</span>,linetype<span class="op">=</span><span class="fl">2</span>,linewidth<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Predicted Density"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Observed Density"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dharmaplot</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/Dharmaplot.html">Dharmaplot</a></span><span class="op">(</span><span class="va">Mill.vast</span>,span <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">resplot</span>,<span class="va">dharmaplot</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>Looks ok!</p>
<p>A second functon can produce maps from the output.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotPredictionMap.html">plotPredictionMap</a></span><span class="op">(</span>streamvast <span class="op">=</span> <span class="va">Mill.vast</span>,mapvar <span class="op">=</span> <span class="st">"pred_Density"</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>These maps can also be faceted by year, month, etc.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotPredictionMap.html">plotPredictionMap</a></span><span class="op">(</span>streamvast <span class="op">=</span><span class="va">Mill.vast</span>, subset<span class="op">=</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">preds</span><span class="op">$</span><span class="va">Year</span><span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2014</span>,<span class="fl">2016</span>,<span class="fl">2018</span>,<span class="fl">2020</span><span class="op">)</span>, mapvar<span class="op">=</span><span class="st">"pred_Density"</span>,facet <span class="op">=</span> <span class="st">"Year"</span>,make.labels <span class="op">=</span> <span class="cn">F</span>,xaxis.breaks <span class="op">=</span> <span class="cn">NA</span>,yaxis.breaks <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>Additional maps can be easily generated using generic plotting
functions. For instance, the average density with respect to space is
stored under the “spacedata” slot.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">spacedata</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Reach</span>,y<span class="op">=</span><span class="va">Density</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Mill Creek - Average Density by Reach"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Reach</span>,y<span class="op">=</span><span class="va">pred_Density</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Reach</span>,y<span class="op">=</span><span class="va">pred_Density_upper</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Reach</span>,y<span class="op">=</span><span class="va">pred_Density_lower</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>Similarly, the pattern over time is stored in “timedata.”</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">year.breaks</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">timedata</span><span class="op">$</span><span class="va">Dayseq</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">timedata</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span>,FUN<span class="op">=</span><span class="va">min</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">timedata</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Dayseq</span>,y<span class="op">=</span><span class="va">Density</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"MAG - Average Density by Reach"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Dayseq</span>,y<span class="op">=</span><span class="va">pred_Density</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Dayseq</span>,y<span class="op">=</span><span class="va">pred_Density_upper</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Dayseq</span>,y<span class="op">=</span><span class="va">pred_Density_lower</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">year.breaks</span><span class="op">$</span><span class="va">x</span>,labels <span class="op">=</span> <span class="va">year.breaks</span><span class="op">$</span><span class="va">Group.1</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<p>The easiest way to save a fitted model is as an RDS object.</p>
<p>In the next chapter, we will discuss some additions and extensions of
this model that can be used to generate escapement estimates for
salmonid populations in the Pacific Northwest.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jeremy Harris.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
