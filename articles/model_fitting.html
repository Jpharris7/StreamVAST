<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="StreamVAST">
<title>Fitting a VAST Model • StreamVAST</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fitting a VAST Model">
<meta property="og:description" content="StreamVAST">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">StreamVAST</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/model_fitting.html">Fitting a VAST Model</a>
    <a class="dropdown-item" href="../articles/shape_prep.html">Preparing a Stream Network</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Fitting a VAST Model</h1>
            
      
      
      <div class="d-none name"><code>model_fitting.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jpharris7.github.io/StreamVAST/" class="external-link">StreamVAST</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/James-Thorson-NOAA/VAST" class="external-link">VAST</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: TMB</span></span>
<span><span class="co">#&gt; Loading required package: FishStatsUtils</span></span>
<span><span class="co">#&gt; Loading required package: units</span></span>
<span><span class="co">#&gt; udunits database from C:/Users/harj3477/AppData/Local/R/win-library/4.2/units/share/udunits/udunits2.xml</span></span>
<span><span class="co">#&gt; ###########################################################################################</span></span>
<span><span class="co">#&gt; Loading package VAST version 3.10.0</span></span>
<span><span class="co">#&gt; For information and examples, please see http://github.com/james-thorson/VAST/</span></span>
<span><span class="co">#&gt; ###########################################################################################</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.9.1, GDAL 3.4.3, PROJ 7.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://luukvdmeer.github.io/sfnetworks/" class="external-link">sfnetworks</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="fitting-a-vast-model-to-stream-network-data">Fitting a VAST Model to Stream Network Data<a class="anchor" aria-label="anchor" href="#fitting-a-vast-model-to-stream-network-data"></a>
</h2>
<p>This is the second chapter explaining how to use the functions in the
StreamVAST package. For information on how to prepare and format data,
please refer to the previous chapter <a href="articles/shape_prep.html">Preparing a Stream Network</a></p>
<p>In the previous chapter, we imported data for steelhead salmon redds
in the Mill Creek watershed, in Washington State. The two most important
data objects are a data frame with the dates and locations of redds, and
an sf object with LINESTRINGS defining the different segments of the
network. A third object, the set of survey tracks is also useful. Future
versions of this package will make use of S3 classes to streamline the
tracking of these objects.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   X Year Day Reach   Effort Redds  STRM_NAME  root parent parent.distance</span></span>
<span><span class="co">#&gt; 1 1 2013  64     1 2465.601     0 Mill Creek  TRUE     NA              NA</span></span>
<span><span class="co">#&gt; 2 2 2013  64     2 3499.699     0 Mill Creek FALSE      1        3499.699</span></span>
<span><span class="co">#&gt; 3 3 2013  64     3 3354.350     0 Mill Creek FALSE      2        3427.024</span></span>
<span><span class="co">#&gt; 4 4 2013  64     4 3354.350     0 Mill Creek FALSE      3        3354.350</span></span>
<span><span class="co">#&gt; 5 5 2013  78     1 2465.601     0 Mill Creek  TRUE     NA              NA</span></span>
<span><span class="co">#&gt; 6 6 2013  78     2 3499.699     0 Mill Creek FALSE      1        3499.699</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Mill.reaches</span>,n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 22 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: LINESTRING</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 941970.7 ymin: 322499 xmax: 963147.4 ymax: 357159.5</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Washington South (ftUS)</span></span>
<span><span class="co">#&gt; First 4 features:</span></span>
<span><span class="co">#&gt;   from to reachid    STRM_NA root parent  prnt_ds</span></span>
<span><span class="co">#&gt; 1    1  2       1 Mill Creek    1     NA       NA</span></span>
<span><span class="co">#&gt; 2    2  3       2 Mill Creek    0      1 3499.699</span></span>
<span><span class="co">#&gt; 3    3  4       3 Mill Creek    0      2 3427.024</span></span>
<span><span class="co">#&gt; 4    4  5       4 Mill Creek    0      3 3354.350</span></span>
<span><span class="co">#&gt;                         geometry</span></span>
<span><span class="co">#&gt; 1 LINESTRING (963147.4 322499...</span></span>
<span><span class="co">#&gt; 2 LINESTRING (961311.9 324437...</span></span>
<span><span class="co">#&gt; 3 LINESTRING (958655.6 326211...</span></span>
<span><span class="co">#&gt; 4 LINESTRING (958123.2 328790...</span></span></code></pre></div>
<div class="section level3">
<h3 id="additional-formatting-for-vast">Additional formatting for VAST<a class="anchor" aria-label="anchor" href="#additional-formatting-for-vast"></a>
</h3>
<p>There are a few more minor formatting tasks that need to be completed
before we can fit a model. We need to draw information from Mill.reaches
to add an “Area” column that tracks the total area in each reach,
separate from the “Effort”. We will also take this opportunity to
convert units from feet into km. The date will also be converted into a
variety of formats (statistical week, Month) that will be useful later.
The objects are returned as elements of a list. This function also
produces a map of the spatial frame and the data coverage provided by
the surveys that can be useful as a diagnostic check.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.list</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/FormatStreamData.html">FormatStreamData</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">Mill.data</span>,reaches <span class="op">=</span> <span class="va">Mill.reaches</span>,surveys <span class="op">=</span> <span class="va">Mill.surveys</span>,unit.conv <span class="op">=</span> <span class="fl">.0003048</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Redd.data</span><span class="op">&lt;-</span><span class="va">Mill.list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">Reach.data</span><span class="op">&lt;-</span><span class="va">Mill.list</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">Survey.data</span><span class="op">&lt;-</span><span class="va">Mill.list</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">vast.input0</span><span class="op">&lt;-</span><span class="va">Mill.list</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">vast.network</span><span class="op">&lt;-</span><span class="va">Mill.list</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">vast.networkLL</span><span class="op">&lt;-</span><span class="va">Mill.list</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>We also need to produce a set of auxiliary data frames that VAST will
use to determine the spatial relationships, and each of these objects
requires a very specific format with specific columns and names. These
are returned as elements 4-6 of the list. The object “vast.input0”
requires Lon and Lat coordinates (from the midpoint of each reach), a
column named “child_i” which is equivalent to the reach id, and a column
for “Area_km2”, which is equivalent the Area calculated above (note that
we are treating stream lengths as if they are areas). We will need to
further modify this object later, after choosing a temporal resolution.
“Vast.network” and “vast.network.LL” are nearly identical, except for
one having Lon and Lat columns. Both require columns for “child_s” which
is the reach id, “parent_s” which is the id of the parent, and “dist_s”
which is what we have been calling “parent.distance”. Note that for the
root, “parent_s” must be set to 0, and “dist_s” must be set to Inf.</p>
</div>
<div class="section level3">
<h3 id="choosing-a-temporal-resolution">Choosing a temporal resolution<a class="anchor" aria-label="anchor" href="#choosing-a-temporal-resolution"></a>
</h3>
<p>Depending on the system being modeled, a variety of temporal
resolutions are possible. Therefore, we will need one additional
formatting step, provided by MakeVASTData. For this example, we will set
the temporal resolution to one month, and will cover the 5 months from
Feb. to June. We will also pad the ends of the data set with zeros, to
mark the ends of the season.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Redd.data.vast.list</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/MakeVASTData.html">MakeVASTData</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">Redd.data</span>,reachdata <span class="op">=</span> <span class="va">Reach.data</span>,countname <span class="op">=</span> <span class="st">"Redds"</span>,Time <span class="op">=</span> <span class="st">"Biweek"</span>,</span>
<span>                                  startdate <span class="op">=</span> <span class="st">"2013-02-01"</span>,enddate <span class="op">=</span> <span class="st">"2022-06-30"</span>,padzero <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">Redd.data.vast</span><span class="op">&lt;-</span><span class="va">Redd.data.vast.list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">time.table</span><span class="op">&lt;-</span><span class="va">Redd.data.vast.list</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">vast.input</span><span class="op">&lt;-</span><span class="va">vast.input0</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">Redd.data.vast</span><span class="op">$</span><span class="va">Reach</span>,<span class="va">vast.input0</span><span class="op">$</span><span class="va">child_i</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<p>This function returns a list with two elements. The first is a data
frame that contains everything we will need for VAST.This data frame has
three important additions. First, the temporal element has been
converted into a generic “Time” period that runs in sequence. It also
includes two columns “Original” and “Dummy”. The Original column
identifies actual data points, while the Dummy column identifies time
periods or reaches for which no data is available, but that we would
like the model to output a prediction.</p>
<p>The second element of the list is a table that is useful for relating
the time period back to it’s normal calendar date. The last step is that
vast.input must have a number of rows equal to Redd.data.vast, so we
will pull from vast.input0 to make the full version.</p>
</div>
<div class="section level3">
<h3 id="an-example-in-vast">An example in VAST<a class="anchor" aria-label="anchor" href="#an-example-in-vast"></a>
</h3>
<p>From this point, we will use VAST functions to setup and run the
model, and the example code here should be used as a guide. The user is
advised to review the documentation for VAST, which contains extensive
options for how to customize your model. Future versions of StreamVAST
may include wrapper functions that automatically choose sensible
options, but for now users can use the code in this document as a model.
The first step is to make a settings object.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FishStatsUtils/man/make_settings.html" class="external-link">make_settings</a></span><span class="op">(</span>Region<span class="op">=</span><span class="st">"stream_network"</span>,</span>
<span>                          zone<span class="op">=</span><span class="fl">10</span>,</span>
<span>                          purpose <span class="op">=</span> <span class="st">"index2"</span>,</span>
<span>                          fine_scale<span class="op">=</span><span class="cn">F</span>,</span>
<span>                          n_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Reach.data</span><span class="op">)</span>,</span>
<span>                          FieldConfig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Omega1"</span><span class="op">=</span> <span class="fl">1</span>, <span class="st">"Epsilon1"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"Omega2"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"Epsilon2"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>                          RhoConfig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Beta1"</span> <span class="op">=</span> <span class="fl">2</span>, <span class="st">"Epsilon1"</span> <span class="op">=</span> <span class="fl">2</span>, <span class="st">"Beta2"</span> <span class="op">=</span> <span class="fl">2</span>, <span class="st">"Epsilon2"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                          OverdispersionConfig <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Eta1"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"Eta2"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                          ObsModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                          bias.correct <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                          use_anisotropy <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">Method</span><span class="op">&lt;-</span><span class="st">"Stream_network"</span>            </span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">grid_size_km</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Reach.data</span><span class="op">$</span><span class="va">Length</span><span class="op">)</span></span></code></pre></div>
<p>It is important to specify that Region = “stream_network”, and to set
n_x equal tot he number of reaches. The zone is the UTM time zone, and
purpose = “index2” specifies that our goal is abundance or density
prediction. FieldConfig is turns various components of the model on or
off (the example removes several terms for simplicity and stability),
and RhoConfig specifies the type autocorrelation (random-walk in this
case). We are not modeling the overdispersion, so these settings are set
to zero. ObsModel controls the distributions and link functions in the
model, with the current setting indicating a Poisson count model with
zero inflation. Anisotropy and fine_scale should be turned off. Please
see the VAST documentation for details.</p>
<p>It is also necessary to manually set the method to “Stream_network”
and to calculate a mean size for the prediction frame.</p>
<p>For this example, we will not use any covariates, but this is the
point where you would set up a covariate data set as well. See the VAST
documentation for details.</p>
<p>Next, we can run the model, using “fit_model” from the VAST package.
While there are many inputs, the preceding steps have made everything
available. Note that some of the values should be converted to units for
the function. Also, VAST will write a number of text files to you active
working directory.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vast.model</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FishStatsUtils/man/fit_model.html" class="external-link">fit_model</a></span><span class="op">(</span><span class="st">"settings"</span> <span class="op">=</span> <span class="va">settings</span>,</span>
<span>                       Lat_i <span class="op">=</span> <span class="va">Redd.data.vast</span><span class="op">$</span><span class="va">Lat</span>,</span>
<span>                       Lon_i <span class="op">=</span> <span class="va">Redd.data.vast</span><span class="op">$</span><span class="va">Lon</span>,</span>
<span>                       t_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">Redd.data.vast</span><span class="op">$</span><span class="va">Time</span><span class="op">)</span>,</span>
<span>                       b_i <span class="op">=</span> <span class="fu">as_units</span><span class="op">(</span><span class="va">Redd.data.vast</span><span class="op">$</span><span class="va">Redds</span>,<span class="st">"count"</span><span class="op">)</span>,</span>
<span>                       a_i <span class="op">=</span> <span class="fu">as_units</span><span class="op">(</span><span class="va">Redd.data.vast</span><span class="op">$</span><span class="va">Effort</span>,<span class="st">"km"</span><span class="op">)</span>,</span>
<span>                       test_fit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                       PredTF_i<span class="op">=</span><span class="va">Redd.data.vast</span><span class="op">$</span><span class="va">dummy</span>,</span>
<span>                       input_grid<span class="op">=</span><span class="va">vast.input</span>,</span>
<span>                       Network_sz<span class="op">=</span><span class="va">vast.network</span>,</span>
<span>                       Network_sz_LL<span class="op">=</span><span class="va">vast.networkLL</span>,</span>
<span>                       newtonsteps <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                       Aniso<span class="op">=</span><span class="cn">F</span>,</span>
<span>                       getsd<span class="op">=</span><span class="cn">T</span>,</span>
<span>                       getHessian<span class="op">=</span><span class="cn">T</span>,</span>
<span>                       max_cells<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Redd.data.vast</span><span class="op">)</span>,</span>
<span>                       Options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'treat_nonencounter_as_zero'</span> <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preliminary-checks-and-troubleshooting">Preliminary checks and Troubleshooting<a class="anchor" aria-label="anchor" href="#preliminary-checks-and-troubleshooting"></a>
</h3>
<p>The object “vast.model” contains many pieces, several of which are
useful to determine if the algorithm has run successfully. A basic check
of the parameter estimates is often advisable.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vast.model</span><span class="op">$</span><span class="va">parameter_estimates</span><span class="op">$</span><span class="va">Convergence_check</span></span>
<span><span class="co">#&gt; [1] "There is no evidence that the model is not converged"</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vast.model</span><span class="op">$</span><span class="va">parameter_estimates</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="co">#&gt;   L_omega1_z L_epsilon1_z    L_beta1_z    logkappa1 Beta_mean1_c    L_beta2_z </span></span>
<span><span class="co">#&gt;    3.5656370    0.4261484    0.6597098   -0.2753906   -1.2886024    1.2725911 </span></span>
<span><span class="co">#&gt; Beta_mean2_c </span></span>
<span><span class="co">#&gt;   -3.2439917</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vast.model</span><span class="op">$</span><span class="va">parameter_estimates</span><span class="op">$</span><span class="va">number_of_coefficients</span></span>
<span><span class="co">#&gt;  Total  Fixed Random </span></span>
<span><span class="co">#&gt;   2669      7   2662</span></span></code></pre></div>
<p>If your model is not converging, experiment with by making the
settings. It is often productive to begin with a simple model (by
inputting 0s in FieldConfig or RhoConfig) and then to gradually increase
the complexity. Refer to the VAST documentation for specifics.</p>
<p>The predictions from the fitted VAST model can be quickly extracted
using a helper function VASTpreds. This function will format the
predictions into a data frame, and provide the density and count
estimates for each reach at each time period. It also provides upper and
lower 90% confidence bounds, based on samples drawn from the posterior
distribution. A second functon can produce maps from the output.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/VASTpreds.html">VASTpreds</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">vast.model</span>,time.table<span class="op">=</span><span class="va">time.table</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotPredictionMap.html">plotPredictionMap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">preds</span>,mapvar <span class="op">=</span> <span class="st">"density"</span>,reaches <span class="op">=</span> <span class="va">Reach.data</span>,</span>
<span>                  reach.names <span class="op">=</span> <span class="st">"reachid"</span>,make.labels <span class="op">=</span> <span class="cn">F</span>,xaxis.breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">123.24</span>,<span class="op">-</span><span class="fl">123.20</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>These maps can also be faceted by year, month, etc.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotPredictionMap.html">plotPredictionMap</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">preds</span>,<span class="va">Year</span><span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2014</span>,<span class="fl">2016</span>,<span class="fl">2018</span>,<span class="fl">2020</span><span class="op">)</span><span class="op">)</span>,mapvar <span class="op">=</span> <span class="st">"density"</span>,reaches <span class="op">=</span> <span class="va">Reach.data</span>,</span>
<span>                  facet <span class="op">=</span> <span class="st">"Year"</span>,reach.names <span class="op">=</span> <span class="st">"reachid"</span>,make.labels <span class="op">=</span> <span class="cn">F</span>,xaxis.breaks <span class="op">=</span> <span class="fl">0</span>,yaxis.breaks <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>Vast is also compatible with the DHARMa package, which provides
scaled residual estimates for hierarchical models, and is a good first
step to assessing model fit. Note that due to compatibility issues, you
must have a copy of the vast.model object named “fit”.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://florianhartig.github.io/DHARMa/" class="external-link">DHARMa</a></span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">&lt;-</span><span class="va">vast.model</span></span>
<span><span class="va">dharmaRes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">vast.model</span>, what<span class="op">=</span><span class="st">"residuals"</span>, type<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_fitting_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>In the final chapter, StreamVAST provides some functions that allow
users to conveniently extract predictions or residuals from the VAST
model, further explore model fit, generate some derived population
metrics, and demonstrates some plotting functions that may be useful to
evaluate or present the results of a model.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jeremy Harris.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
