<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimating Salmonid Escapement after Fitting a VAST model • StreamVAST</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimating Salmonid Escapement after Fitting a VAST model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">StreamVAST</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/model_fitting.html">Fitting a VAST Model</a></li>
    <li><a class="dropdown-item" href="../articles/shape_prep.html">Preparing a Stream Network</a></li>
    <li><a class="dropdown-item" href="../articles/survival_example.html">Estimating Salmonid Escapement after Fitting a VAST model</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Estimating Salmonid Escapement after Fitting a VAST model</h1>
            
      

      <div class="d-none name"><code>survival_example.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jpharris7.github.io/StreamVAST/">StreamVAST</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="co">#&gt; Loading required package: sp</span></span>
<span><span class="co">#&gt; This is INLA_24.02.09 built 2024-02-09 03:35:28 UTC.</span></span>
<span><span class="co">#&gt;  - See www.r-inla.org/contact-us for how to get help.</span></span>
<span><span class="co">#&gt;  - List available models/likelihoods/etc with inla.list.models()</span></span>
<span><span class="co">#&gt;  - Use inla.doc(&lt;NAME&gt;) to access documentation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.11.2, GDAL 3.8.2, PROJ 9.3.1; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="va">Mill.vast</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"Mill_vastmodel.rds"</span><span class="op">)</span></span>
<span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">surveydata</span><span class="op">&lt;-</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">surveydata</span>,<span class="st">"wgs84"</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="estimating-salmonid-escapement">Estimating Salmonid Escapement<a class="anchor" aria-label="anchor" href="#estimating-salmonid-escapement"></a>
</h4>
<p>This project was originally designed to support salmonid population
monitoring in the state of Washington, US. While the other chapters
focus on more general applications, this chapter will cover methods that
are more specific to the Pacific Northwest salmonid community.</p>
</div>
<div class="section level2">
<h2 id="from-redd-density-to-fish-populations">From Redd Density to Fish Populations<a class="anchor" aria-label="anchor" href="#from-redd-density-to-fish-populations"></a>
</h2>
<p>While in some cases it may be possible to directly model the number
of unique redds, most spawning ground monitoring suffers from
difficulties, interruptions, and lack of coverage that make this
infeasible. Instead this method focuses on the “area under the curve” or
AUC method (not to be confused with the “area under the receiver
operating curve” metric which is sometimes abbreviated AUC). In this
method, the predicted number of total (non-unique) redds is plotted over
time.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat1</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">preds</span>,<span class="va">Year</span><span class="op">==</span><span class="fl">2015</span> <span class="op">&amp;</span> <span class="va">Reach</span><span class="op">==</span><span class="fl">9</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pred_Redds"</span>,<span class="st">"Statday"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat1</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Redds"</span>,<span class="st">"Day"</span><span class="op">)</span></span>
<span><span class="va">dat1</span><span class="op">$</span><span class="va">group</span><span class="op">&lt;-</span><span class="st">"Predicted"</span></span>
<span><span class="va">dat2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">countdata</span>,<span class="va">Year</span><span class="op">==</span><span class="fl">2015</span> <span class="op">&amp;</span> <span class="va">Reach</span><span class="op">==</span><span class="fl">9</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Redds"</span>,<span class="st">"Day"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">dat2</span><span class="op">$</span><span class="va">group</span><span class="op">&lt;-</span><span class="st">"Observed"</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">dat1</span>,<span class="va">dat2</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Day</span>,y<span class="op">=</span><span class="va">Redds</span>,col<span class="op">=</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Day</span>,y<span class="op">=</span><span class="va">Redds</span>,col<span class="op">=</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Year 2015 - Reach 9"</span><span class="op">)</span></span></code></pre></div>
<p><img src="survival_example_files/figure-html/unnamed-chunk-2-1.png" width="700">
The area under the curve is calculated separately for each reach and
year combination. The calculations were made in the previous chapter
when using the VASTpreds function and can be accessed from the aucdata
slot in the streamVAST object.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">aucdata</span><span class="op">$</span><span class="va">auctotals</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Runyear          AUC       pred_AUC      pred_AUC_lower    pred_AUC_upper  </span></span>
<span><span class="co">#&gt;  Min.   :2013   Min.   :0   Min.   : 117.5   Min.   :  77.57   Min.   : 420.3  </span></span>
<span><span class="co">#&gt;  1st Qu.:2015   1st Qu.:0   1st Qu.: 220.8   1st Qu.: 162.59   1st Qu.: 612.5  </span></span>
<span><span class="co">#&gt;  Median :2018   Median :0   Median : 367.0   Median : 298.21   Median : 781.8  </span></span>
<span><span class="co">#&gt;  Mean   :2018   Mean   :0   Mean   : 577.6   Mean   : 488.35   Mean   : 942.0  </span></span>
<span><span class="co">#&gt;  3rd Qu.:2020   3rd Qu.:0   3rd Qu.: 842.7   3rd Qu.: 696.77   3rd Qu.:1107.9  </span></span>
<span><span class="co">#&gt;  Max.   :2022   Max.   :0   Max.   :1475.0   Max.   :1351.78   Max.   :1873.4  </span></span>
<span><span class="co">#&gt;   pred_AUC_SD    </span></span>
<span><span class="co">#&gt;  Min.   : 76.75  </span></span>
<span><span class="co">#&gt;  1st Qu.: 88.81  </span></span>
<span><span class="co">#&gt;  Median :121.86  </span></span>
<span><span class="co">#&gt;  Mean   :136.40  </span></span>
<span><span class="co">#&gt;  3rd Qu.:154.82  </span></span>
<span><span class="co">#&gt;  Max.   :253.66</span></span></code></pre></div>
<p>The area under the curve will be in units of Redds*Days. If we divide
this number by the residence or survival time of redds, the result will
be an estimate of the number of unique redds. This value can be obtained
from expert opinion or the literature, but if repeated observations of
redds are available it is not difficult to model.</p>
</div>
<div class="section level2">
<h2 id="modeling-redd-survival">Modeling Redd Survival<a class="anchor" aria-label="anchor" href="#modeling-redd-survival"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.redds.sf</span><span class="op">&lt;-</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span>dsn<span class="op">=</span><span class="st">"Mill_Creek_redds_example.shp"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `Mill_Creek_redds_example' from data source </span></span>
<span><span class="co">#&gt;   `C:\Users\harj3477\Jeremy Documents\R materials\StreamVAST\vignettes\Mill_Creek_redds_example.shp' </span></span>
<span><span class="co">#&gt;   using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 389 features and 8 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 942128.8 ymin: 322744.9 xmax: 1149562 ymax: 357187</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Washington South (ftUS)</span></span>
<span><span class="va">Mill.redds.sf</span><span class="op">&lt;-</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">Mill.redds.sf</span>,<span class="st">"wgs84"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Mill.redds</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">Mill.redds.sf</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"rdd_nm_"</span>,<span class="st">"srvy_dt"</span>,<span class="st">"rdd_st_"</span><span class="op">)</span><span class="op">]</span>,lon<span class="op">=</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">Mill.redds.sf</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,lat<span class="op">=</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">Mill.redds.sf</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Mill.redds</span><span class="op">$</span><span class="va">srvy_dt</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">Mill.redds</span><span class="op">$</span><span class="va">srvy_dt</span>,FUN<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">x</span>,split<span class="op">=</span><span class="st">" "</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Mill.redds</span><span class="op">$</span><span class="va">day</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strptime.html" class="external-link">strftime</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/strptime.html" class="external-link">strptime</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Mill.redds</span><span class="op">$</span><span class="va">srvy_dt</span>,format<span class="op">=</span><span class="st">"%m/%d/%Y"</span><span class="op">)</span>,format<span class="op">=</span><span class="st">"%j"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.redds</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Year    rdd_nm_   srvy_dt rdd_st_       lon      lat day</span></span>
<span><span class="co">#&gt; 1 2022 RD00015368 4/25/2022      NR -123.1926 46.19579 115</span></span>
<span><span class="co">#&gt; 2 2022 RD00019698 4/12/2022      NR -123.2086 46.21647 102</span></span>
<span><span class="co">#&gt; 3 2022 RD00019698 4/25/2022      SV -123.2086 46.21647 115</span></span>
<span><span class="co">#&gt; 4 2022 RD00019699 4/12/2022      NR -123.2545 46.24179 102</span></span>
<span><span class="co">#&gt; 5 2022 RD00019699 4/25/2022      SV -123.2545 46.24179 115</span></span>
<span><span class="co">#&gt; 6 2022 RD00028389 4/25/2022      NR -123.2351 46.27183 115</span></span></code></pre></div>
<p>First we recall the redd data from before and do some minor
formatting. Each redd must have a date, a unique id number, and a set of
coordinates. It must also have a status code that uses the “NR” for New
Redds, “SV” for Still Visible redds that have been observed previously,
and “NV” for Not Visible redds that were previously observed but are no
longer identifiable.</p>
<p>Next, the MakeReddSurvival function will process the data into a
usable form. Because we have surveyed each reach multiple times, we can
use the intervals between surveys and the redd status codes to determine
a minimum and maximum survival time for each redd.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.survdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/MakeReddSurvival.html">MakeReddSurvival</a></span><span class="op">(</span>streamvast <span class="op">=</span> <span class="va">Mill.vast</span>,redds <span class="op">=</span> <span class="va">Mill.redds</span>,redd.ids <span class="op">=</span> <span class="st">"rdd_nm_"</span>,</span>
<span>                           redd.crs <span class="op">=</span> <span class="st">"wgs84"</span>,redd.status <span class="op">=</span> <span class="st">"rdd_st_"</span>,survey.tol <span class="op">=</span> <span class="fl">250</span><span class="op">)</span></span>
<span><span class="co">#&gt;   |                                                                              |                                                                      |   0%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |===                                                                   |   5%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |=====                                                                 |   8%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  17%  |                                                                              |============                                                          |  18%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |==============                                                        |  21%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |=================                                                     |  25%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |==========================                                            |  38%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  39%  |                                                                              |============================                                          |  40%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |===============================                                       |  44%  |                                                                              |===============================                                       |  45%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |=================================                                     |  48%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |===================================                                   |  51%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  57%  |                                                                              |========================================                              |  58%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |==========================================                            |  61%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  62%  |                                                                              |============================================                          |  63%  |                                                                              |============================================                          |  64%  |                                                                              |=============================================                         |  64%  |                                                                              |=============================================                         |  65%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |===============================================                       |  68%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |======================================================                |  78%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  79%  |                                                                              |========================================================              |  80%  |                                                                              |========================================================              |  81%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |===========================================================           |  85%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |=============================================================         |  88%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |===============================================================       |  91%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |=================================================================     |  94%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |====================================================================  |  98%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================| 100%</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.survdata</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Redd Year min.start max.start min.end max.end min.duration max.duration</span></span>
<span><span class="co">#&gt; 1 RD00015368 2022       103       115     116     129            1           26</span></span>
<span><span class="co">#&gt; 2 RD00019698 2022        81       102     116     129           14           48</span></span>
<span><span class="co">#&gt; 3 RD00019699 2022        81       102     116     129           14           48</span></span>
<span><span class="co">#&gt; 4 RD00028389 2022       103       115     116     129            1           26</span></span>
<span><span class="co">#&gt; 5 RD00028390 2022       103       115     116     129            1           26</span></span>
<span><span class="co">#&gt; 6 RD00028897 2022       116       131     132     145            1           29</span></span>
<span><span class="co">#&gt;   Reach       lon      lat complete</span></span>
<span><span class="co">#&gt; 1     2 -123.1926 46.19579    FALSE</span></span>
<span><span class="co">#&gt; 2     6 -123.2086 46.21647    FALSE</span></span>
<span><span class="co">#&gt; 3    11 -123.2545 46.24179    FALSE</span></span>
<span><span class="co">#&gt; 4    17 -123.2351 46.27183    FALSE</span></span>
<span><span class="co">#&gt; 5     3 -123.1964 46.20197    FALSE</span></span>
<span><span class="co">#&gt; 6     6 -123.2090 46.21606    FALSE</span></span></code></pre></div>
<div class="section level3">
<h3 id="inla-survival-model">INLA survival model<a class="anchor" aria-label="anchor" href="#inla-survival-model"></a>
</h3>
<p>For the survival model, we can use existing methods in INLA to fit a
pretty good survival model without much difficulty. This model will use
a simplified spatial graph that estimates spatial covariances based on
adjacency as opposed to distance. A function has been included to
conveniently generate the required matrix.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.mat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/AdjacencyMatrix.html">AdjacencyMatrix</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">reachdata</span><span class="op">)</span></span></code></pre></div>
<p>We will build the model in INLA directly. First, we will convert the
data into a survival object. Using ‘event’ code 3 specifies that the
data is interval censored to be between time and time2.</p>
<p>Then the model itself is fit, with random walk effects on Year and a
besag ICAR effect for space based on the adjaceny graph. The family can
be either ‘gamma.surv’ or ‘weibull.surv’ and users are encouraged to
experiment to find the distribution best for their data.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.inla.surv</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/surv.html" class="external-link">inla.surv</a></span><span class="op">(</span>time<span class="op">=</span><span class="va">Mill.survdata</span><span class="op">$</span><span class="va">min.duration</span>,event<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Mill.survdata</span><span class="op">)</span><span class="op">)</span>,time2 <span class="op">=</span> <span class="va">Mill.survdata</span><span class="op">$</span><span class="va">max.duration</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Mill.inla</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla</a></span><span class="op">(</span><span class="va">Mill.inla.surv</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Year</span>,model<span class="op">=</span><span class="st">"rw1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Reach</span>,model<span class="op">=</span><span class="st">"besag"</span>,graph <span class="op">=</span> <span class="va">Mill.mat</span><span class="op">)</span>,</span>
<span>               data<span class="op">=</span><span class="va">Mill.survdata</span>,family<span class="op">=</span><span class="st">"gamma.surv"</span>,control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>waic<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in inla.model.properties.generic(inla.trim.family(model), mm[names(mm) == : Model 'gammasurv' in section 'likelihood' is marked as 'experimental'; changes may appear at any time.</span></span>
<span><span class="co">#&gt;   Use this model with extra care!!! Further warnings are disabled.</span></span></code></pre></div>
<p>The hyperparameter estimated in INLA is the shape parameter of the
estimated gamma distribution. INLA uses a slightly unusual
parameterization of the rate parameter. The SurvivalTable function
converts the results of the model into tabular format with shape and
scale parameters capable with the distribution functions (dgamma, etc.)
in base R. From these distributions, we can compute the median survival
time estimated for each year and reach.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.gamma.table</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/SurvivalTable.html">SurvivalTable</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">Mill.inla</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.gamma.table</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Year Reach    Shape    Scale  MedLife</span></span>
<span><span class="co">#&gt; 1 2013     1 10.70806 2.368362 24.57563</span></span>
<span><span class="co">#&gt; 2 2013     2 10.70806 2.370724 24.60014</span></span>
<span><span class="co">#&gt; 3 2013     3 10.70806 2.373694 24.63095</span></span>
<span><span class="co">#&gt; 4 2013     4 10.70806 2.380152 24.69796</span></span>
<span><span class="co">#&gt; 5 2013     5 10.70806 2.388422 24.78378</span></span>
<span><span class="co">#&gt; 6 2013     6 10.70806 2.397176 24.87461</span></span></code></pre></div>
<p>The survival values can be plotted in a variety of ways and the
plotSurvivalHistogram and plotSurvivalCurves functions will help.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotSurvivalCurves.html">plotSurvivalCurves</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">Mill.inla</span>,data <span class="op">=</span> <span class="va">Mill.survdata</span>,</span>
<span>                              title <span class="op">=</span> <span class="st">"Mill Creek: Median Survival"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fl">80</span><span class="op">)</span></span></code></pre></div>
<p><img src="survival_example_files/figure-html/unnamed-chunk-9-1.png" width="700">
The final step is to match the predictions of survival time to the auc
predictions. This is easily accomplished with the MakeEscapement
function. This will fill the “escapedata” slot of the streamvast object,
and contains estimates of escapement by reach and year, as well as
totals by year.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Mill.vast</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/MakeEscapement.html">MakeEscapement</a></span><span class="op">(</span>streamvast <span class="op">=</span> <span class="va">Mill.vast</span>,survival <span class="op">=</span> <span class="va">Mill.gamma.table</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">$</span><span class="va">escapedata</span><span class="op">$</span><span class="va">escapedata</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Runyear Reach    Escape Escape_lower Escape_upper Escape_SD</span></span>
<span><span class="co">#&gt; 1    2013     1 0.5076596    0.1628871     1.971844 0.5247303</span></span>
<span><span class="co">#&gt; 2    2013     2 1.0979841    0.4006307     3.940403 0.9227687</span></span>
<span><span class="co">#&gt; 3    2013     3 2.2323037    1.1909101     4.420250 0.9661213</span></span>
<span><span class="co">#&gt; 4    2013     4 2.5235409    1.1567162     6.813785 1.3288599</span></span>
<span><span class="co">#&gt; 5    2013     5 5.8685031    3.3022716     9.269785 1.7579439</span></span>
<span><span class="co">#&gt; 6    2013     6 9.9483273    6.3363619    15.465090 2.3689752</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotEscapement.html">plotEscapement</a></span><span class="op">(</span><span class="va">Mill.vast</span><span class="op">)</span></span></code></pre></div>
<p><img src="survival_example_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jeremy Harris.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
